
@{
    ViewBag.Title = "Subdist Join";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style type="text/css">
    .bd-example-modal-lg .modal-dialog {
        display: table;
        position: relative;
        margin: 0 auto;
        top: calc(50% - 24px);
    }
</style>

<div class="container">
    <div class="col-md-12">
        <h3><b>@ViewBag.Title</b></h3>
        <hr />
    </div>
    <div class="col-md-12">
        <div class="form-group row" id="subdistAwal" style="display: flex; align-items: center;">
            <label class="col-sm-4 col-form-label">Pilih Subdist yang Ingin Diindukkan</label>
            <div class="col-sm-8">
                <select id="sel_Subdist">
                </select>
            </div>
        </div>
        <div class="form-group row" style="display: none; margin-bottom: 0" id="errKode1">
            <div class="col-sm-4"></div>
            <label class="col-sm-6 col-form-label" style="color: red; font-weight: bold; margin-bottom: 0">Mohon pilih subdist awal terlebih dahulu</label>
        </div>
        <div class="form-group row" id="subdistInduk">
            <label class="col-sm-4 col-form-label">Pilih Subdist Induk</label>
            <div class="col-sm-8">
                <select id="sel_Subdist_induk">
                </select>
            </div>
        </div>
        <div class="form-group row" style="display: none; margin-bottom: 0" id="errKode2">
            <div class="col-sm-4"></div>
            <label class="col-sm-6 col-form-label" style="color: red; font-weight: bold; margin-bottom: 0">Mohon pilih subdist induk terlebih dahulu</label>
        </div>
        <div class="form-group row">
            <div class="col-sm-4"></div>
            <div class="col-sm-2">
                <button class="btn btn-primary btn-md " id="btnSubmit" type="button" style="background-color:darkcyan;color:white;">Simpan</button>
            </div>
        </div>
        <hr />
    </div>
    <div class="col-md-12">
        <h5><b><u>Tabel Indukkan Subdist Saat Ini</u></b></h5>
    </div>
    <div class="col-md-12">
        <table id="tblSubdist" class="table table-striped table-bordered zero-configuration"  style="width: 100%; align-items: center;">
            <thead>
                <tr>
                    <th width="1%">No</th>
                    <th width="15%">Kode Subdist</th>
                    <th width="25%">Nama Subdist</th>
                    <th width="20%">Kode Subdist Induk</th>
                    <th width="25%">Nama Subdist Induk</th>
                    <th width="5%">Action</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

<div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title" id="myModalLabel">Edit Mapping Subdist</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" action="#">
                    <div class="form-group row">
                        <label class="col-sm-4 col-form-label" for="subdit_code">Kode Subdist</label>
                        <div class="col-sm-8">
                            <input type="text" id="subdit_code" class="form-control" disabled>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-4 col-form-label" for="subdit_name">Nama Subdist</label>
                        <div class="col-sm-8">
                            <input type="text" id="subdit_name" class="form-control" disabled>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-4 col-form-label" for="subdit_name">Pilih Grouping SPB</label>
                        <div class="col-sm-8">
                            <select id="sel_GroupSPB_update" name="groupSPB">
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light waves-effect" data-dismiss="modal" id="btnClose">Tutup</button>
                <button type="button" class="btn btn-primary waves-effect waves-light" id="btnSubmit">Simpan</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>

<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<script src="~/Scripts/sweetalert2.all.min.js"></script>
<script src="~/Scripts/select2.min.js"></script>
<script src="~/Scripts/jquery.dataTables.min.js"></script>

<script>
    $('#sel_Subdist').select2({
        placeholder: 'Pilih subdist awal'
    });

    $('#sel_Subdist_induk').select2({
        placeholder: 'Pilih subdist induk'
    });

    const getSubdistJoin = () => {
        var table = $('#tblSubdist').DataTable();
        table.destroy();
        $.ajax({
            type: 'post',
            url: "subdist",
            async: false,
            data: JSON.stringify({
                OPTION: "GET_SUBDIST_JOIN"
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (res) {
                console.log(JSON.parse(res));
                $("#tblSubdist").DataTable({
                    "data": JSON.parse(res),
                    "lengthChange": true,
                    "searching": true,
                    "scrollCollapse": true,
                    "select": true,
                    "columns": [
                        { "data": "row_num" },
                        { "data": "ToKodeSubdist" },
                        { "data": "ToNamaSubdist" },
                        { "data": "KodeSubdist" },
                        { "data": "NamaSubdist" },
                        {
                            "data": null,
                            "defaultContent": '<button class="pilih btn btn-primary" >Pilih</button>'
                        }
                    ]
                })
            },
        });
    }

    const getSubdistAwal = () => {
        $.ajax({
            type: "POST",
            url: "subdist",
            data: JSON.stringify({
                Option: "GET_ALL_SUBDIST"
            }),
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (res) {
                $('#sel_Subdist').empty()
                result = ''
                JSON.parse(res).forEach(item => {
                    result += `<option value="${item.KodeSubdist}">${item.SubdistDisplay}</option>`
                })
                $('#sel_Subdist').append('<option></option>')
                $('#sel_Subdist').append(result)
            }
        });
    }

    const getSubdistInduk = () => {
        $.ajax({
            type: "POST",
            url: "subdist",
            data: JSON.stringify({
                Option: "GET_ALL_SUBDIST"
            }),
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (res) {
                $('#sel_Subdist_induk').empty()
                result = ''
                JSON.parse(res).forEach(item => {
                    result += `<option value="${item.KodeSubdist}">${item.SubdistDisplay}</option>`
                })
                $('#sel_Subdist_induk').append('<option></option>')
                $('#sel_Subdist_induk').append(result)
            }
        });
    }

    const saveSubdistJoin = () => {
        $.ajax({
            type: "POST",
            url: "subdist",
            data: JSON.stringify({
                Option: "SAVE_SUBDIST_JOIN",
                KodeSubdist: $('#sel_Subdist').val(),
                IndukKodeSubdist: $('#sel_Subdist_induk').val()
            }),
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (res) {
                console.log(res);
                let result = JSON.parse(res)[0].RESULT
                if (result === 'true') {
                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: 'Subdist join berhasil tersimpan',
                        timer: 2500,
                        buttons: false,
                        showConfirmButton: false,
                        timerProgressBar: true,
                    }).then(function () {
                        getSubdistJoin();
                    })
                } else {
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: 'Terdapat kesalahan data, mohon periksa kembali',
                        showConfirmButton: false,
                        timerProgressBar: true,
                        timer: 5000
                    })
                }
            }
        });
    }

    $(document).ready(function () {
        getSubdistJoin();
        getSubdistAwal();
        getSubdistInduk();

        $('#tblSubdist tbody').on('click', 'button.pilih', function () {
            var rows = $(this).closest("tr");
            var data = $('#tblSubdist').DataTable().row(rows).data();

            $('#sel_Subdist').val(data.ToKodeSubdist).trigger('change');
            $('#sel_Subdist_induk').val(data.KodeSubdist).trigger('change');
        })

        $('#btnSubmit').on('click', function () {
            let cek1 = false;
            let cek2 = false;

            if ($('#sel_Subdist').val() === '') {
                document.getElementById('errKode1').style.display = 'flex';
                document.getElementById('subdistAwal').style.marginBottom = 0;
                cek1 = false;
            } else {
                document.getElementById('errKode1').style.display = 'none';
                document.getElementById('subdistAwal').style.marginBottom = '1rem';
                cek1 = true;
            }

            if ($('#sel_Subdist_induk').val() === '') {
                document.getElementById('errKode2').style.display = 'flex';
                document.getElementById('subdistInduk').style.marginBottom = 0;
                cek2 = false;
            } else {
                document.getElementById('errKode2').style.display = 'none';
                document.getElementById('subdistInduk').style.marginBottom = '1rem';
                cek2 = true;
            }

            if (cek1 && cek2) saveSubdistJoin();
        })
    })
</script>